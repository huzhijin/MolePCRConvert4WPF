<UserControl x:Class="MolePCRConvert4WPF.App.Views.ReportTemplateConfigView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:MolePCRConvert4WPF.App.Views"
             xmlns:vm="clr-namespace:MolePCRConvert4WPF.App.ViewModels"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance Type=vm:ReportTemplateConfigViewModel, IsDesignTimeCreatable=False}"
             d:DesignHeight="700" d:DesignWidth="1000"
             Background="{DynamicResource MaterialDesignPaper}">

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
            <RowDefinition Height="Auto" />
        </Grid.RowDefinitions>

        <!-- 标题 -->
        <TextBlock Grid.Row="0" Text="报告模板配置" Style="{StaticResource MaterialDesignHeadline6TextBlock}" Margin="0,0,0,16" />

        <!-- 工具栏 -->
        <materialDesign:Card Grid.Row="1" Padding="16" Margin="0,0,0,16" UniformCornerRadius="4">
            <StackPanel Orientation="Horizontal">
                <Button Style="{StaticResource MaterialDesignRaisedButton}" 
                        ToolTip="添加新的报告模板"
                        Command="{Binding AddTemplateCommand}"
                        IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}" 
                        Margin="0,0,16,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="FilePlus" Margin="0,0,8,0" />
                        <TextBlock Text="添加模板" />
                    </StackPanel>
                </Button>
                
                <Button Style="{StaticResource MaterialDesignOutlinedButton}" 
                        ToolTip="使用ReoGrid设计器创建新模板"
                        Command="{Binding CreateNewTemplateCommand}"
                        IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}" 
                        Margin="0,0,16,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="TablePlus" Margin="0,0,8,0" />
                        <TextBlock Text="创建新模板" />
                    </StackPanel>
                </Button>
                
                <Button Style="{StaticResource MaterialDesignOutlinedButton}" 
                        ToolTip="使用ReoGrid设计器编辑选中的模板"
                        Command="{Binding DesignTemplateCommand}"
                        Margin="0,0,16,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="TableEdit" Margin="0,0,8,0" />
                        <TextBlock Text="编辑模板" />
                    </StackPanel>
                </Button>
                
                <Button Style="{StaticResource MaterialDesignOutlinedButton}" 
                        ToolTip="查看选中的报告模板"
                        Command="{Binding ViewTemplateCommand}"
                        Margin="0,0,16,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="FileEye" Margin="0,0,8,0" />
                        <TextBlock Text="查看模板" />
                    </StackPanel>
                </Button>
                
                <Button Style="{StaticResource MaterialDesignOutlinedSecondaryButton}" 
                        ToolTip="删除选中的报告模板"
                        Command="{Binding DeleteTemplateCommand}"
                        Margin="0,0,16,0">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="FileRemove" Margin="0,0,8,0" />
                        <TextBlock Text="删除模板" />
                    </StackPanel>
                </Button>
                
                <Button Style="{StaticResource MaterialDesignOutlinedButton}" 
                        ToolTip="刷新模板列表"
                        Command="{Binding RefreshCommand}"
                        IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="Refresh" Margin="0,0,8,0" />
                        <TextBlock Text="刷新" />
                    </StackPanel>
                </Button>
                
                <!-- 新增：修复模板按钮 -->
                <Button Style="{StaticResource MaterialDesignOutlinedButton}" 
                        ToolTip="修复模板问题,解决预览错误"
                        Click="BtnFixTemplates_Click"
                        Margin="16,0,0,0"
                        IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBooleanConverter}}">
                    <StackPanel Orientation="Horizontal">
                        <materialDesign:PackIcon Kind="FileRestore" Margin="0,0,8,0" />
                        <TextBlock Text="修复模板" />
                    </StackPanel>
                </Button>
                
                <!-- 加载指示器 -->
                <ProgressBar Style="{StaticResource MaterialDesignCircularProgressBar}" 
                             Value="0" IsIndeterminate="True" 
                             Width="24" Height="24" 
                             Margin="16,0,0,0"
                             Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" />
            </StackPanel>
        </materialDesign:Card>

        <!-- 模板列表 -->
        <materialDesign:Card Grid.Row="2" Padding="16" UniformCornerRadius="4">
            <Grid>
                <DataGrid ItemsSource="{Binding Templates}" 
                          SelectedItem="{Binding SelectedTemplate}"
                          AutoGenerateColumns="False"
                          IsReadOnly="True"
                          CanUserAddRows="False"
                          CanUserDeleteRows="False"
                          Margin="0"
                          materialDesign:DataGridAssist.CellPadding="13 8 13 8" 
                          materialDesign:DataGridAssist.ColumnHeaderPadding="13 8 13 8">
                    <DataGrid.ContextMenu>
                        <ContextMenu>
                            <MenuItem Header="编辑模板" Command="{Binding DesignTemplateCommand}">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="TableEdit" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="重命名" Command="{Binding RenameTemplateCommand}">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="Rename" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <MenuItem Header="删除" Command="{Binding DeleteTemplateCommand}">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="Delete" />
                                </MenuItem.Icon>
                            </MenuItem>
                            <Separator />
                            <MenuItem Header="在资源管理器中显示" Command="{Binding ShowInExplorerCommand}">
                                <MenuItem.Icon>
                                    <materialDesign:PackIcon Kind="FolderOpen" />
                                </MenuItem.Icon>
                            </MenuItem>
                        </ContextMenu>
                    </DataGrid.ContextMenu>
                    <DataGrid.Columns>
                        <materialDesign:DataGridTextColumn Header="模板名称" Binding="{Binding Name}" Width="2*" />
                        <materialDesign:DataGridTextColumn Header="文件路径" Binding="{Binding FilePath}" Width="3*" />
                        <materialDesign:DataGridTextColumn Header="模板类型" Width="*">
                            <materialDesign:DataGridTextColumn.Binding>
                                <MultiBinding StringFormat="{}{0}{1}{2}">
                                    <Binding Path="IsReoGridTemplate" Converter="{StaticResource BoolToStringConverter}" ConverterParameter="ReoGrid,," />
                                    <Binding Path="IsExcelTemplate" Converter="{StaticResource BoolToStringConverter}" ConverterParameter="Excel,," />
                                    <Binding Path="IsHtmlTemplate" Converter="{StaticResource BoolToStringConverter}" ConverterParameter="HTML,," />
                                </MultiBinding>
                            </materialDesign:DataGridTextColumn.Binding>
                        </materialDesign:DataGridTextColumn>
                        <materialDesign:DataGridTextColumn Header="创建时间" Binding="{Binding CreatedAt, StringFormat=yyyy-MM-dd HH:mm:ss}" Width="*" />
                    </DataGrid.Columns>
                </DataGrid>
                
                <!-- 无模板时的提示 -->
                <TextBlock Text="暂无报告模板，请点击&#x201C;添加模板&#x201D;按钮添加" 
                           HorizontalAlignment="Center" 
                           VerticalAlignment="Center"
                           FontSize="16"
                           Foreground="{DynamicResource MaterialDesignBodyLight}"
                           Visibility="{Binding Templates.Count, Converter={StaticResource ZeroToVisibleConverter}}" />
            </Grid>
        </materialDesign:Card>

        <!-- 状态栏 -->
        <materialDesign:Card Grid.Row="3" Padding="8 4" Margin="0,16,0,0" UniformCornerRadius="4">
            <TextBlock Text="{Binding StatusMessage}" Margin="8,4" />
        </materialDesign:Card>
    </Grid>
</UserControl> 
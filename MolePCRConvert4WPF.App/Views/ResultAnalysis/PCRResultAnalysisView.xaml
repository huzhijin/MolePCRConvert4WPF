<UserControl x:Class="MolePCRConvert4WPF.App.Views.ResultAnalysis.PCRResultAnalysisView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:MolePCRConvert4WPF.App.Views.ResultAnalysis"
             xmlns:vm="clr-namespace:MolePCRConvert4WPF.App.ViewModels"
             xmlns:conv="clr-namespace:MolePCRConvert4WPF.App.Converters" 
             xmlns:models="clr-namespace:MolePCRConvert4WPF.Core.Models;assembly=MolePCRConvert4WPF.Core"
             xmlns:system="clr-namespace:System;assembly=mscorlib"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance Type=vm:PCRResultAnalysisViewModel, IsDesignTimeCreatable=False}"
             d:DesignHeight="600" d:DesignWidth="900"
             Background="{DynamicResource MaterialDesignPaper}">
    
    <UserControl.Resources>
        <!-- 系统转换器 -->
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter" />
        
        <!-- 字符串格式 -->
        <system:String x:Key="CtValueFormat">F1</system:String>
        <system:String x:Key="ConcentrationFormat">F2</system:String>
        
        <!-- 样式定义 -->
        <Style TargetType="DataGridRow" x:Key="PatientRowStyle">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsFirstPatientRow}" Value="True">
                    <Setter Property="BorderThickness" Value="0,4,0,0"/>
                    <Setter Property="BorderBrush" Value="#3F51B5"/>
                    <Setter Property="Background" Value="#E8EAF6"/>
                    <Setter Property="Margin" Value="0,8,0,0"/>
                    <Setter Property="FontWeight" Value="Bold"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding PatientName}" Value="">
                    <Setter Property="Background" Value="#F5F5F5"/>
                    <Setter Property="Foreground" Value="#757575"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        
        <!-- 结果列样式 -->
        <Style TargetType="DataGridCell" x:Key="DetectionResultCellStyle">
             <Setter Property="TextBlock.TextAlignment" Value="Center"/>
             <Style.Triggers>
                 <DataTrigger Binding="{Binding FinalResult}" Value="阳性">
                     <Setter Property="Background" Value="#FFDDDD"/>
                     <Setter Property="Foreground" Value="#B71C1C"/>
                     <Setter Property="FontWeight" Value="Bold"/>
                 </DataTrigger>
                 <DataTrigger Binding="{Binding FinalResult}" Value="阴性">
                     <Setter Property="Background" Value="#DDFFDD"/>
                     <Setter Property="Foreground" Value="#1B5E20"/>
                 </DataTrigger>
                 <DataTrigger Binding="{Binding FinalResult}" Value="未检出">
                     <Setter Property="Foreground" Value="Gray"/>
                     <Setter Property="FontStyle" Value="Italic"/>
                 </DataTrigger>
                  <DataTrigger Binding="{Binding FinalResult}" Value="无法判定">
                     <Setter Property="Foreground" Value="OrangeRed"/>
                 </DataTrigger>
                 <DataTrigger Binding="{Binding FinalResult}" Value="无效">
                     <Setter Property="Background" Value="LightGray"/>
                     <Setter Property="Foreground" Value="Red"/>
                     <Setter Property="FontWeight" Value="Bold"/>
                 </DataTrigger>
                  <DataTrigger Binding="{Binding FinalResult}" Value="无适用规则">
                     <Setter Property="Foreground" Value="DimGray"/>
                      <Setter Property="ToolTip" Value="此孔位/通道组合没有匹配的分析规则"/>
                 </DataTrigger>
                 <DataTrigger Binding="{Binding FinalResult}" Value="无判定规则">
                     <Setter Property="Foreground" Value="DimGray"/>
                     <Setter Property="ToolTip" Value="没有设置判定规则"/>
                 </DataTrigger>
                 <DataTrigger Binding="{Binding FinalResult}" Value="公式错误">
                     <Setter Property="Foreground" Value="Red"/>
                     <Setter Property="ToolTip" Value="公式计算错误，请检查公式语法"/>
                 </DataTrigger>
             </Style.Triggers>
         </Style>
    </UserControl.Resources>
    
    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- 1. Title Area -->
        <TextBlock Grid.Row="0" Text="PCR结果分析" Style="{StaticResource MaterialDesignHeadline6TextBlock}" Margin="15"/>
        
        <!-- 2. Main Content Area -->
        <Grid Grid.Row="1" Margin="15,0,15,15">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>
            
            <!-- 2a. Button Panel -->
            <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,10">
                <!-- Refresh Button: Enabled when not loading -->
                <Button Content="刷新分析" Width="100" Height="30" 
                        Command="{Binding RefreshCommand}" 
                        IsEnabled="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}, ConverterParameter=Invert}" 
                        Margin="0,0,10,0"/>
                <!-- Other Buttons: Rely on Command's CanExecute -->
                <Button Content="导出结果" Width="100" Height="30" 
                        Command="{Binding ExportCommand}" 
                        Margin="0,0,10,0"/> 
                <Button Content="生成患者报告" Width="120" Height="30" 
                        Command="{Binding GeneratePatientReportCommand}" 
                        Margin="0,0,10,0"/>
                <Button Content="生成整板报告" Width="120" Height="30" 
                        Command="{Binding GeneratePlateReportCommand}"/>
                <!-- Added ToggleButton/CheckBox for showing all patients -->
                 <CheckBox Content="显示所有患者" 
                           IsChecked="{Binding ShowAllPatients, Mode=TwoWay}" 
                           VerticalAlignment="Center" 
                           Margin="20,0,0,0"/>
            </StackPanel>
            
            <!-- 2b. Results DataGrid -->
            <DataGrid Grid.Row="1" ItemsSource="{Binding DisplayedResults}" 
                      AutoGenerateColumns="False" 
                      IsReadOnly="True"
                      CanUserAddRows="False" 
                      CanUserDeleteRows="False"
                      HeadersVisibility="Column"
                      RowStyle="{StaticResource PatientRowStyle}"
                      BorderThickness="1" 
                      BorderBrush="{DynamicResource MaterialDesignDivider}">
                <DataGrid.Columns>
                    <!-- Patient Name Column -->
                    <DataGridTextColumn Header="患者姓名" Binding="{Binding PatientName}" Width="120">
                        <DataGridTextColumn.CellStyle>
                            <Style TargetType="DataGridCell" BasedOn="{StaticResource MaterialDesignDataGridCell}">
                                <Style.Triggers>
                                    <!-- Bold the name on the first row of the patient group -->
                                    <DataTrigger Binding="{Binding IsFirstPatientRow}" Value="True">
                                        <Setter Property="FontWeight" Value="Bold"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </DataGridTextColumn.CellStyle>
                    </DataGridTextColumn>
                    
                    <!-- Well Position Column -->
                    <DataGridTextColumn Header="孔位" Binding="{Binding WellPosition}" Width="60" ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}" CellStyle="{StaticResource MaterialDesignDataGridCell}"/>
                    
                    <!-- Channel Column -->
                    <DataGridTextColumn Header="荧光通道" Binding="{Binding Channel}" Width="80" ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}" CellStyle="{StaticResource MaterialDesignDataGridCell}"/>
                    
                    <!-- Target Name Column (Microbe Name in reference) -->
                     <DataGridTextColumn Header="靶标名称" Binding="{Binding TargetName}" Width="130" ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}" CellStyle="{StaticResource MaterialDesignDataGridCell}"/>
                   
                    <!-- CT Value Column -->
                    <DataGridTextColumn Header="CT值" Width="80" ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}" CellStyle="{StaticResource MaterialDesignDataGridCell}">
                        <DataGridTextColumn.Binding>
                            <Binding Path="CtValue">
                                <Binding.TargetNullValue>
                                    <system:String>-</system:String>
                                </Binding.TargetNullValue>
                            </Binding>
                        </DataGridTextColumn.Binding>
                    </DataGridTextColumn>
                    
                    <!-- Concentration Column -->
                    <DataGridTextColumn Header="浓度" Width="100" ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}" CellStyle="{StaticResource MaterialDesignDataGridCell}">
                        <DataGridTextColumn.Binding>
                            <Binding Path="Concentration" StringFormat="{StaticResource ConcentrationFormat}"> <!-- Define ConcentrationFormat in Resources -->
                                <Binding.TargetNullValue>
                                    <system:String>-</system:String>
                                </Binding.TargetNullValue>
                            </Binding>
                        </DataGridTextColumn.Binding>
                    </DataGridTextColumn>
                                       
                    <!-- Detection Result Column -->
                    <DataGridTextColumn Header="检测结果" Binding="{Binding FinalResult}" Width="90" ElementStyle="{StaticResource MaterialDesignDataGridTextColumnStyle}" CellStyle="{StaticResource DetectionResultCellStyle}"/>

                </DataGrid.Columns>
            </DataGrid>
        </Grid>
        
        <!-- 3. Status Bar -->
        <StatusBar Grid.Row="2">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}" Margin="5,0"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Text="{Binding TotalCount, StringFormat={}总记录: {0}}" Margin="5,0"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Text="{Binding PatientCount, StringFormat={}患者数: {0}}" Margin="5,0"/>
            </StatusBarItem>
             <StatusBarItem HorizontalAlignment="Right">
                 <ProgressBar IsIndeterminate="True" 
                              Visibility="{Binding IsLoading, Converter={StaticResource BooleanToVisibilityConverter}}" 
                              Width="100" Height="15" Margin="5,0"/>
             </StatusBarItem>
        </StatusBar>
    </Grid>
</UserControl> 